#include <stdio.h>
#include <string.h>
#include <string.h>
#include "socket.h"
#include "traiter_client.h"
#include<sys/socket.h>
#include<netinet/in.h>
#include<netinet/ip.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <stdlib.h>



void initialiser_signaux(void)
{
  if(signal(SIGPIPE,SIG_IGN) == SIG_ERR)
   {
     perror("signal");
   }
 struct sigaction sa;
  sa.sa_handler = traitement_signal;
  sigemptyset(&sa.sa_mask);
  sa.sa_flags = SA_RESTART;
  if (sigaction(SIGCHLD, &sa ,NULL) == -1)
  {
   perror("sigaction(SIGCHLD)");
  }
}

void traitement_signal(int sig)
{ 
  while(waitpid(-1,NULL,WNOHANG) == 0);
  printf("Signal %d reÃ§u\n" ,sig);
}



/**
Main !
**/

int main ()
{
 initialiser_signaux();
 int serveur=creer_serveur(8000);
  if(serveur == -1){
  perror("creer serveur"); 
  return -1;
  }

 while(1){
   int socket_client ;
   int f;
   socket_client = accept(serveur, NULL , NULL);
   f = fork();
  if(f==0)
  {
    traiter_client(socket_client);
   }
  else if(f > 0)
  {

   close(socket_client);
  }
  else if(f<0)
  {
   perror("erreur fork negatif");
  }
  if ( socket_client == -1)
  {
   perror ("accept");
   return -1;
  }
 
 }
return 0;
}

